# ğŸš€ EnergyHub Marketplace Auto-Commit PowerShell Script
# ======================================================

Write-Host "ğŸš€ EnergyHub Marketplace Auto-Commit" -ForegroundColor Cyan
Write-Host "====================================" -ForegroundColor Cyan

# Function to write colored output
function Write-ColorOutput($ForegroundColor) {
    $fc = $host.UI.RawUI.ForegroundColor
    $host.UI.RawUI.ForegroundColor = $ForegroundColor
    if ($args) {
        Write-Output $args
    } else {
        $input | Write-Output
    }
    $host.UI.RawUI.ForegroundColor = $fc
}

# Get current timestamp
$timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
$date = Get-Date -Format "yyyy-MM-dd"

# Check if we're in a git repository
try {
    git rev-parse --git-dir 2>$null | Out-Null
    if ($LASTEXITCODE -ne 0) {
        Write-ColorOutput Red "âŒ Not in a git repository!"
        exit 1
    }
} catch {
    Write-ColorOutput Red "âŒ Git not found or not in a repository!"
    exit 1
}

# Check for changes
$changes = git status --porcelain
if (-not $changes) {
    Write-ColorOutput Green "âœ… No changes to commit"
    exit 0
}

Write-ColorOutput Yellow "ğŸ“Š Found changes in repository"

# Show git status
Write-Host ""
Write-Host "ğŸ“Š Current Git Status:" -ForegroundColor Blue
Write-Host "=====================" -ForegroundColor Blue
git status --short

Write-Host ""
$response = Read-Host "ğŸ¤” Do you want to commit these changes? (y/N)"

if ($response -ne "y" -and $response -ne "Y") {
    Write-ColorOutput Yellow "âš ï¸ Auto-commit cancelled by user"
    exit 0
}

# Add all changes
Write-ColorOutput Blue "ğŸ“¦ Adding all changes..."
git add .

# Count changed files
$changedFiles = (git diff --cached --name-only | Measure-Object).Count
Write-ColorOutput Blue "â„¹ï¸ Ready to commit $changedFiles file(s)"

# Generate smart commit message
$commitMsg = @"
ğŸ”„ Auto-commit: Development updates ($date)

ğŸ“Š Summary:
- Files changed: $changedFiles
- Timestamp: $timestamp

ğŸ”§ Changes include:
"@

# Analyze changed files for better commit message
$cachedFiles = git diff --cached --name-only

if ($cachedFiles -match "README\.md") {
    $commitMsg += "`n- ğŸ“š Documentation updates"
}

if ($cachedFiles -match "package\.json|package-lock\.json") {
    $commitMsg += "`n- ğŸ“¦ Dependencies updated"
}

if ($cachedFiles -match "src/") {
    $commitMsg += "`n- ğŸ’» Frontend code changes"
}

if ($cachedFiles -match "backend/") {
    $commitMsg += "`n- ğŸ–¥ï¸ Backend API updates"
}

if ($cachedFiles -match "\.css|\.scss|tailwind") {
    $commitMsg += "`n- ğŸ¨ Styling improvements"
}

$commitMsg += "`n`nGenerated by PowerShell auto-commit script âš¡"

# Commit changes
Write-ColorOutput Blue "ğŸ’¾ Committing changes..."
git commit -m $commitMsg

if ($LASTEXITCODE -eq 0) {
    Write-ColorOutput Green "âœ… Commit successful!"
    
    # Push to remote
    Write-ColorOutput Blue "ğŸš€ Pushing to remote repository..."
    git push origin main
    
    if ($LASTEXITCODE -eq 0) {
        Write-ColorOutput Green "âœ… Push successful! Changes are now live."
        Write-ColorOutput Cyan "ğŸŒ View your repository: https://github.com/SHADRACK152/energyhub_marketplace"
    } else {
        Write-ColorOutput Red "âŒ Push failed. Please check your connection and try again."
        exit 1
    }
} else {
    Write-ColorOutput Red "âŒ Commit failed!"
    exit 1
}

Write-ColorOutput Green "ğŸ‰ Auto-commit completed successfully!"
Write-Host ""
Write-Host "Press any key to continue..." -ForegroundColor Gray
$null = $Host.UI.RawUI.ReadKey("NoEcho,IncludeKeyDown")
